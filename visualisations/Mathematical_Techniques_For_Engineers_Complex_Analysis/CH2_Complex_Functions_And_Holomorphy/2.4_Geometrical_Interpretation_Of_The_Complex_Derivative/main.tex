% Figure consists of 4 parts (in this order in the code)
% Surface D (upper left)
% Detail plot highlighted square (lower left)
% Surface S (non-linear transformation of surface D) (upper right)
% Detail plot highlighted square on surface S (lower right)
\documentclass{article}
\usepackage{tikz}
\usepackage{float}
\usepackage{lmodern}
\usepackage{amsmath}
\usetikzlibrary{calc}
\usetikzlibrary{intersections}
\usetikzlibrary{decorations.markings}
\usetikzlibrary{arrows, arrows.meta}
\usetikzlibrary{patterns,patterns.meta}
\usetikzlibrary{shapes}
\usepgfmodule{nonlineartransformations}

\begin{document}

\centering

\begin{tikzpicture}[scale=1.0, xshift=1.347cm]  
\pgfmathsetmacro{\PictureScale}{1.0}        % set scale as used for tikzpicture!
\pgfmathsetmacro{\CircleSize}{0.03}         % radius of coordinate circles/dots
% conversion from cm to pt and vice versa
\pgfmathsetmacro{\CmToPt}{28.3464566929}
\pgfmathsetmacro{\PtToCm}{0.0352777778}
% define styles used in this picture
\tikzset{every node/.style={font=\scriptsize,text=black},
CircleNodeStyle/.style={draw=black, shape=circle, fill=black, minimum size=\CircleSize*2.5 cm, inner sep=0pt},
arrowstyle/.style={->, >=stealth}}

% declare pgflayers
\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}

\colorlet{BlueBackground}{blue!5}
 % Background for entire canvas
\begin{pgfonlayer}{background}
    \fill[BlueBackground] (-2.44,-2.44) rectangle (4.8,4.0);
\end{pgfonlayer}

%% AXES
\pgfmathsetmacro{\OvershootAxis}{0.5}
% x-axis variables
\pgfmathsetmacro{\XAxisLength}{2.0}
\pgfmathsetmacro{\AngleAxis}{45}
\pgfmathsetmacro{\ZAxisBeginX}{cos(\AngleAxis) * \OvershootAxis * 0.7}
\pgfmathsetmacro{\ZAxisBeginY}{ sin(\AngleAxis) * \OvershootAxis * 0.7}
\pgfmathsetmacro{\ZAxisEndX}{- cos(\AngleAxis)*\XAxisLength}
\pgfmathsetmacro{\ZAxisEndY}{ - sin(\AngleAxis) * \XAxisLength}

\begin{pgfonlayer}{background}
% draw y and z-axes
\draw[arrowstyle, thick, name path=YAxis] (-\OvershootAxis,0) -- (3.8,0) node[pos=1, right] {$y$};
\draw[arrowstyle, thick] (0,-\OvershootAxis) -- (0,3.0) node[pos=1, above] {$z$};
% draw x axis
\draw[arrowstyle, thick, name path=XAxis] (\ZAxisBeginX, \ZAxisBeginY) -- (\ZAxisEndX, \ZAxisEndY) node[pos=1, below left] {$x$};
\end{pgfonlayer}


% surface D variables (u and v)
\pgfmathsetmacro{\Startuv}{0.5}
\pgfmathsetmacro{\Endu}{3.5}
\pgfmathsetmacro{\Endv}{2}
\pgfmathsetmacro{\usegments}{4}
\pgfmathsetmacro{\vsegments}{4}
\pgfmathsetmacro{\ustepsize}{(\Endu-\Startuv)/\usegments}
\pgfmathsetmacro{\vstepsize}{(\Endv-\Startuv)/\vsegments}

% u and v index, of highlighted tangent point
\pgfmathsetmacro{\HiglightedIndexU}{2}
\pgfmathsetmacro{\HiglightedIndexV}{2}

% define offsets for the surface (in pt)
\pgfmathsetmacro{\XOffsetSurface}{6.0}
\pgfmathsetmacro{\YOffsetSurface}{10.0}


% surface S (non-linear transformation of surface D)
% the nonlinear transformation is calibrated on a certain figure
% dimensions of calibrated surface
\pgfmathsetmacro{\XWidthOrig}{7.0}
\pgfmathsetmacro{\YWidthOrig}{7.0}
\pgfmathsetmacro{\StartXOrig}{0.0}
\pgfmathsetmacro{\StartYOrig}{5.0}
% nonlinear parts of the transformation (x^2, x*y...) need to be scaled to calibration size (via "scale") to ensure no deformation (non-linear transformation on figure size 10 won't have same effect as on a figure with size 1)
\pgfmathsetmacro{\Xscale}{(\Endu - \Startuv) / (\XWidthOrig*1.4)}   % original object xdim / calibrated object xdim
\pgfmathsetmacro{\Yscale}{(\Endv - \Startuv) / (\YWidthOrig*1.4)}
\pgfmathsetmacro{\scale}{(\Xscale+\Yscale)/2 * \PictureScale}
\pgfmathsetmacro{\ScopeScale}{0.8}                      % applied zoom-factor (in scope)
\pgfmathsetmacro{\ScaleInScope}{\ScopeScale * \scale}   % resulting scale in scope

% Function: non linear transformation
% nonlinear parts (x^2, x*y, ...) were selected by adding them one by one for desired result
\makeatletter
\def\CustomNonlinearTransformation#1#2#3{%
% #1: x shift
% #2: y shift
% #3: scaling factor
\pgfmathsetmacro{\offsetx}{\pgf@x + #1}
\pgfmathsetmacro{\offsety}{\pgf@y + #2}
\pgfmathsetmacro{\myX}{\offsetx + 0.001*\pgf@y*\pgf@y / #3 + 0.0005*\pgf@x*\pgf@y / #3} %
\pgfmathsetmacro{\myY}{\offsety - 0.002*\pgf@x*\pgf@x / #3 + 0.0008*\pgf@x*\pgf@y / #3} %
\setlength{\pgf@x}{\myX pt}
\setlength{\pgf@y}{\myY pt}
}
\makeatother

% define corners of transformation highlighted square: flip indices for X as image appears to be flipped
\pgfmathsetmacro{\ScaledXOrig}{\StartXOrig * \scale}
\pgfmathsetmacro{\ScaledYOrig}{\StartYOrig * \scale}
\pgfmathsetmacro{\MaxX}{\ScaledXOrig - \ustepsize * (\usegments)}
\pgfmathsetmacro{\MaxY}{\ScaledYOrig + \vstepsize * (\vsegments)}

%% track the position of non-linear transformation with no shift. 
% Resulting position of the tracker is then used to position figure
\def\TrackPosition#1#2#3#4{%
%#1: Tracker x-position
%#2: Tracker y-position
%#3: ScopeScale
%#4: ScaleInScope
\begin{scope}[scale=#3]
    \pgftransformnonlinear{\CustomNonlinearTransformation{0.0}{0.0}{#4}}
    \coordinate (Tracker) at (#1, #2);
\end{scope}
% extract x- and y-dimension
\newdimen\xshiftneg 
\newdimen\yshiftneg
\pgfextractx{\xshiftneg}{\pgfpointanchor{Tracker}{center}} 
\pgfextracty{\yshiftneg}{\pgfpointanchor{Tracker}{center}}
% shift is the inverse of the tracker position
\pgfmathsetmacro{\xshiftOrig}{ -\xshiftneg} 
\pgfmathsetmacro{\yshiftOrig}{ -\yshiftneg}
}

% define x- and y-shift
\TrackPosition{\MaxX}{\MaxY}{\ScopeScale}{\ScaleInScope}
\pgfmathsetmacro{\xshiftTot}{\xshiftOrig + (0.5) * \CmToPt } 
\pgfmathsetmacro{\yshiftTot}{\yshiftOrig + 1.5*\CmToPt}

% define corners of transformation highlighted tangent point: flip indices for X as image appears to be flipped
\pgfmathsetmacro{\HighlightedX}{- \ustepsize * (\usegments - \HiglightedIndexU)}
\pgfmathsetmacro{\HighlightedY}{ \vstepsize * (\HiglightedIndexV)}
% Define begin and end points of lines
\pgfmathsetmacro{\HighlightedMinX}{- \ustepsize * 0}
\pgfmathsetmacro{\HighlightedMaxX}{- \ustepsize * (\usegments)}
\pgfmathsetmacro{\HighlightedMinY}{\vstepsize * 0}
\pgfmathsetmacro{\HighlightedMaxY}{\vstepsize * (\vsegments)}

% need reference points to calculate the partial derivative close to the highlighted point z0
\pgfmathsetmacro{\epsderiv}{0.5}            % increase (as fraction of stepsize) for derivative calculation
\pgfmathsetmacro{\segmentseps}{1 / \epsderiv} 
\pgfmathsetmacro{\RefX}{\HighlightedX + \ustepsize * \epsderiv}
\pgfmathsetmacro{\RefY}{\HighlightedY + \vstepsize * \epsderiv}


% draw surface D and apply non linear transformation -> surface S
\begin{scope}[scale=\ScopeScale, xshift=\ScaledXOrig * \CmToPt, yshift=\ScaledYOrig * \CmToPt, draw=gray]
    \pgftransformnonlinear{\CustomNonlinearTransformation{\xshiftTot *  \PictureScale + \XOffsetSurface}{\yshiftTot * \PictureScale + \YOffsetSurface}{\ScaleInScope}}
    % draw the surface S segments
    \foreach \uindex in {0,...,\usegments}
        \pgfmathsetmacro{\Xcoord}{- \ustepsize * \uindex}
        \pgfmathsetmacro{\YcoordA}{\vstepsize * \vsegments}
        \pgfmathsetmacro{\YcoordB}{0}
        \draw[semithick] (\Xcoord, \YcoordA)--(\Xcoord, \YcoordB);
    \foreach \vindex in {0,...,\vsegments}
        \pgfmathsetmacro{\Ycoord}{\vstepsize * \vindex}
        \pgfmathsetmacro{\XcoordA}{ - \ustepsize * \usegments}
        \pgfmathsetmacro{\XcoordB}{0}
        \draw[semithick] (\XcoordA, \Ycoord)--(\XcoordB, \Ycoord);
    % draw contour of surface D and highlighted tangent point
    \draw[thick, black]  (0, 0) -- ( - \ustepsize * \usegments,  0) -- ( - \ustepsize * \usegments,  \vstepsize * \vsegments) -- (0, \vstepsize * \vsegments) -- cycle;
    % draw the x- and y-tangent on curved surface
    \draw[thick, red] (\HighlightedX, \HighlightedMinY) -- (\HighlightedX, \HighlightedMaxY);
    \draw[thick, red] (\HighlightedMinX, \HighlightedY) -- (\HighlightedMaxX, \HighlightedY);
    % Coordinates that are transformed 
    % (nodes don't transform well direclty with nonlinear transformations...)
    \coordinate (FunctionCoord) at (- \ustepsize * \usegments, 0.0);    % coord for S-node
    \coordinate (HighlightedCoord) at (\HighlightedX, \HighlightedY);
    \coordinate (XderivCoord) at (\RefX, \HighlightedY);
    \coordinate (YderivCoord) at (\HighlightedX, \RefY);
\end{scope}     


% draw plane based on derivatives (as definition tangent plane)
\pgfmathsetmacro{\XMagnifierTop}{\segmentseps * (\usegments - \HiglightedIndexU)}
\coordinate (Xtop) at ($(HighlightedCoord)!\XMagnifierTop!(XderivCoord)$);
\pgfmathsetmacro{\YMagnifierTop}{\segmentseps * (\vsegments - \HiglightedIndexV)}
\coordinate (Ytop) at ($(HighlightedCoord)!\YMagnifierTop!(YderivCoord)$);
% helper coordinates for calculation of plane's corners: equal to x- and y-side length of the plane
\coordinate (Xside) at ($(Xtop) - (HighlightedCoord)$);
\coordinate (Yside) at ($(Ytop) - (HighlightedCoord)$);
% manually adjust coordinates (to make more visually intuitive)
\pgfmathsetmacro{\CosAngle}{cos(\AngleAxis) }
\pgfmathsetmacro{\SinAngle}{sin(\AngleAxis) }
\coordinate (YsideTop) at ($(Yside) + 0.1*(\CosAngle, \SinAngle)$);
\coordinate (YsideBottom) at ($(Yside) - 0.1*(\CosAngle, \SinAngle)$);
\coordinate (XsideTop) at ($(Xside) + 0.06*(1, 0)$);
\coordinate (XsideBottom) at ($(Xside) - 0.10*(1, 0)$);
% Define coordinates for tangents
\coordinate (UpperMid) at ($(HighlightedCoord) + (YsideTop)$);
\coordinate (MidRight) at ($(HighlightedCoord) + (XsideTop)$);
\coordinate (LowerMid) at ($(HighlightedCoord) - (YsideBottom)$);
\coordinate (MidLeft) at ($(HighlightedCoord) - (XsideBottom)$);

% define plane corners
\coordinate (UpperRight) at ($ (UpperMid) + (XsideTop) $);
\coordinate (LowerRight) at ($ (MidRight) - (YsideBottom) $);
\coordinate (LowerLeft) at ($ (LowerMid) - (XsideBottom) $);
\coordinate (UpperLeft) at ($ (MidLeft) + (YsideTop) $);

% define intersection for tangents
% for y tangent
% calculate the intersection between the upper side of the plane and the extension of the tangent4114
\path[name path=UpperSide] (UpperLeft) -- (UpperRight); 
\path[name path=YTangentPath] (LowerMid) -- ($(LowerMid)!3!(HighlightedCoord)$); 
\path[name intersections={of=UpperSide and YTangentPath, by=YTangentIntersect}];
% for x tangent
\path[name path=RightSide] (UpperRight) -- (LowerRight); 
\path[name path=XTangentPath] (MidLeft) -- ($(MidLeft)!3!(HighlightedCoord)$); 
\path[name intersections={of=RightSide and XTangentPath, by=XTangentIntersect}];

\begin{pgfonlayer}{foreground}

% draw the tangent plane
\draw[thick, red, postaction={fill=red, opacity=.4}] (LowerLeft) -- (UpperLeft) -- (UpperRight) -- (LowerRight) -- cycle;

% draw the tangent lines
\draw[thick, black, postaction={decorate}, decoration={
    markings,
    mark=at position 1.0 with {\node[above] {$t_x$};}}] (LowerMid) -- (YTangentIntersect);
\draw[thick, black, postaction={decorate}, decoration={
    markings,
    mark=at position 1.0 with {\node[left] {$t_y$};}}] (XTangentIntersect) -- (MidLeft);

% draw labels
\node at ($ (UpperLeft) + (-0.15, 0.15) $) {\scriptsize $\alpha$};      % Symbol of tangent plane
\node [CircleNodeStyle] at (HighlightedCoord) {};                       % highlight tangent point
\node at ($ (HighlightedCoord) + (-0.45, 0.20) $) {$g(x_{0}, y_{0})$}; 

\end{pgfonlayer}


% Function for extracting x and y coordinates
\newcommand{\ExtractCoordXY}[3]{%
    \newdimen\XCoordPt
    \newdimen\YCoordPt 
    \pgfextractx{\XCoordPt}{\pgfpointanchor{#1}{center}}%
    \pgfextracty{\YCoordPt}{\pgfpointanchor{#1}{center}}%
    % convert from Pt to cm
    \pgfmathsetmacro#2{\XCoordPt * \PtToCm}%
    \pgfmathsetmacro#3{\YCoordPt * \PtToCm}%
}

% manually define projection height
\pgfmathsetmacro{\ProjectionZ}{-1.0}

\begin{scope}[scale=\ScopeScale, xshift=\ScaledXOrig * \CmToPt, yshift=\ScaledYOrig * \CmToPt, draw=gray]
    \pgftransformnonlinear{\CustomNonlinearTransformation{\xshiftTot *  \PictureScale + \XOffsetSurface}{\yshiftTot * \PictureScale + \YOffsetSurface}{\ScaleInScope}}
    \coordinate (SurfaceUpper) at (\HighlightedX, \vstepsize * \vsegments);
    \coordinate (SurfaceRight) at (0.0, \HighlightedY);
    \coordinate (SurfaceLower) at (\HighlightedX, 0.0);
    \coordinate (SurfaceLeft) at ( - \ustepsize * \usegments, \HighlightedY);
\end{scope}

% calculate height of parallellogram to help with construction projection
\ExtractCoordXY{Yside}{\DumpVariable}{\YsideHeight}


% project coordinates to a certain Z-projection height
\ExtractCoordXY{HighlightedCoord}{\XCoord}{\YCoord}
\coordinate (HighlightedCoordProjected) at (\XCoord, \ProjectionZ); 
\ExtractCoordXY{SurfaceUpper}{\XCoord}{\YCoord}       % Call function to retrieve x position
\coordinate (SurfaceUpperProjected) at (\XCoord, \ProjectionZ + 0.57*\YsideHeight); 
\ExtractCoordXY{SurfaceRight}{\XCoord}{\YCoord}
\coordinate (SurfaceRightProjected) at (\XCoord, \ProjectionZ); 
\ExtractCoordXY{SurfaceLower}{\XCoord}{\YCoord}
\coordinate (SurfaceLowerProjected) at (\XCoord, \ProjectionZ - 0.38*\YsideHeight); 
\ExtractCoordXY{SurfaceLeft}{\XCoord}{\YCoord}
\coordinate (SurfaceLeftProjected) at (\XCoord, \ProjectionZ); 

% draw the coordinates on the curved surface
\node [CircleNodeStyle] at (SurfaceLower) {};
\node [CircleNodeStyle] at (SurfaceRight) {};
\node [CircleNodeStyle] at (SurfaceLeft) {};
\node [CircleNodeStyle] at (SurfaceUpper) {};

% begin a pgf layer for background objects
\begin{pgfonlayer}{background}

% draw the projected coordinates
\node [CircleNodeStyle] at (HighlightedCoordProjected) {};
\node [CircleNodeStyle] at (SurfaceUpperProjected) {};
\node [CircleNodeStyle] at (SurfaceRightProjected) {};
\node [CircleNodeStyle] at (SurfaceLowerProjected) {};
\node [CircleNodeStyle] at (SurfaceLeftProjected) {};

% draw the projection lines
\draw [semithick, densely dashed] (HighlightedCoord) -- (HighlightedCoordProjected);
\draw [semithick, densely dashed] (SurfaceUpper) -- (SurfaceUpperProjected);
\draw [semithick, densely dashed] (SurfaceRightProjected) -- (SurfaceRight);
\draw [semithick, densely dashed] (SurfaceLowerProjected) -- (SurfaceLower);
\draw [semithick, densely dashed] (SurfaceLeftProjected) -- (SurfaceLeft);

% calculate and draw the projections of the x- and y-tangents
% define the extensions of the projected tangents
\path[name path=YAxisProjection] (SurfaceLowerProjected) -- ($(SurfaceLowerProjected)!3!(SurfaceUpperProjected)$);
\path[name path=XAxisProjection] (SurfaceRightProjected) -- ($(SurfaceRightProjected)!2!(SurfaceLeftProjected)$);
% calculate the intersections with the X- and Y-axis
\path[name intersections={of=YAxisProjection and YAxis, by=YPointProjection}];
\path[name intersections={of=XAxisProjection and XAxis, by=XPointProjection}];
% draw the projections of the x- and y-tangents
\draw [semithick, densely dashed, postaction={decorate}, decoration={
    markings,
    mark=at position 1.0 with {\node[above] {$y_{0}$};}}] (SurfaceLowerProjected) -- (YPointProjection);
\draw [semithick, densely dashed, postaction={decorate}, decoration={
    markings,
    mark=at position 1.0 with {\node[left] {$x_{0}$};}}] (SurfaceRightProjected) -- (XPointProjection);

% Labels
\node[ellipse, inner sep=0, fill=BlueBackground] at ($ (FunctionCoord) + (-0.075, -0.15) $) {\scriptsize $g(x,y)$};
\node at ($ (HighlightedCoordProjected) + (0.35, -0.25) $) {$(x_{0}, y_{0})$};

\end{pgfonlayer}


\end{tikzpicture}

\end{document}